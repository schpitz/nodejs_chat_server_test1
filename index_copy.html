<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Chat</title>
    <link rel="stylesheet" href="css/main.css">

</head>
<body>
<div class="chat">
    <input type="text" class="chat-name" placeholder="Enter your name...">
    <div class="chat-messages">
        <div class="chat-message">
            <div class="chat-message-sender">Lior:</div>
            <div class="chat-message-time">14/9/2014</div>
            <div class="chat-message-content">Hello there</div>
        </div>

        <div class="chat-message">
            <div class="chat-message-sender">Betty:</div>
            <div class="chat-message-time">15/9/2014</div>
            <div class="chat-message-content">Howdie</div>
        </div>

        <!--<div class="chat-message">-->
        <!--Betty: Howdie...-->
        <!--</div>-->
    </div>
    <textarea class="chat-text-area" placeholder="Type your message..."></textarea>
    <div class="chat-status">Status : <span>idle</span></div>
</div>

<script src="http://127.0.0.1:8080/socket.io/socket.io.js"></script>


<script>
    (function () {
        var getNode = function (s) {
            return document.querySelector(s);
        };

        // Get required notes
        var textarea = getNode('.chat-text-area');
        var chatname = getNode('.chat-name');
        var messages = getNode('.chat-messages');
        var status = getNode('.chat-status span');

        var statusDefault = status.textContent;
        var setStatus = function (s) {
            status.textContent = s;

            // Set back to default
            if (s !== statusDefault) {
                var delay = setTimeout(function () {
                    setStatus(statusDefault);
                    clearInterval(delay);
                }, 3000);
            }
        };
        setStatus('Testing.');


        var socket;
        try {
            socket = io.connect('http://127.0.0.1:8080');
        } catch (e) {
            // Warn user
            console.log("error! can't find mongoDB server");
        }


        if (socket != undefined) {

            // Listen for output
            socket.on('output', function (data) {
                console.log(data);

                if (data.length) {

                    // loop through results
                    for (var x = 0; x < data.length; x++) {
                        var message = document.createElement('div');

                        message.setAttribute('class', 'chat-message');
                        message.textContent = data[x].name + " : " + data[x].message;

                        // Append
                        messages.appendChild(message);
                        messages.insertBefore(message, messages.firstChild);       //

                    }
                }
            });

//            function sortToHtML(name,text) {
//
//            }

            // Listen for status
            socket.on('status', function (data) {
                // If we the data is an object-message (string) or object
                setStatus((typeof data === 'object') ? data.message : data);
                if (data.clear === true) {
                    textarea.value = '';
                }
            });


            // Listen for keydown -> send message on certain event (enter key)
            textarea.addEventListener('keydown', function (event) {
                var self = this;
                var name = chatname.value;

//                console.log(event);                               // Print the key HEX value

                // Send message only if both ENTER pressed and Shift not-pressed
                if ((event.which === 13) && (event.shiftKey === false)) {
                    console.log("message sent!");
                    socket.emit('input', {
                                name: name,
                                message: self.value
                            }
                    );
                }
            })
        }
    })();


</script>

</body>
</html>